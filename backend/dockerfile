# ─── Stage 1: deps ────────────────────────────────────────────────────────────
# Instala SOLO dependencias de producción para que la imagen final sea pequeña.
FROM node:22-alpine AS deps
WORKDIR /app

COPY package*.json ./
RUN npm ci --omit=dev

# ─── Stage 2: build ───────────────────────────────────────────────────────────
# Instala todo (incluyendo devDeps) y compila TypeScript.
FROM node:22-alpine AS builder
WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

# Genera el Prisma Client antes de compilar NestJS
RUN npx prisma generate

RUN npm run build

# ─── Stage 3: runner ──────────────────────────────────────────────────────────
# Imagen final mínima: solo el dist/ compilado + node_modules de producción.
FROM node:22-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# Copia dependencias de producción del stage deps
COPY --from=deps /app/node_modules ./node_modules

# Copia el build de NestJS
COPY --from=builder /app/dist ./dist

# Copia el Prisma Client generado (necesario en runtime)
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Copia schema + migraciones (prisma migrate deploy las necesita)
COPY prisma ./prisma
COPY package*.json ./

EXPOSE 3000

# prisma migrate deploy aplica migraciones pendientes de forma segura en producción.
# Nunca crea ni modifica migraciones, solo las ejecuta.
CMD ["sh", "-c", "npx prisma migrate deploy && node dist/main"]