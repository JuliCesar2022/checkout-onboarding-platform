# ─── Stage 1: deps ────────────────────────────────────────────────────────────
# Instala SOLO dependencias de producción para que la imagen final sea pequeña.
FROM node:24-alpine AS deps
WORKDIR /app

COPY package*.json ./
RUN npm ci --omit=dev

# ─── Stage 2: build ───────────────────────────────────────────────────────────
# Instala todo (incluyendo devDeps) y compila TypeScript.
FROM node:24-alpine AS builder
WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

# Genera el Prisma Client antes de compilar NestJS
RUN npx prisma generate

RUN npm run build

# ─── Stage 3: runner ──────────────────────────────────────────────────────────
# Imagen final mínima: solo el dist/ compilado + node_modules de producción.
FROM node:24-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# Copia dependencias de producción del stage deps
COPY --from=deps /app/node_modules ./node_modules

# Copia el build de NestJS
COPY --from=builder /app/dist ./dist

# Copia el Prisma Client generado (necesario en runtime)
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Copia schema + migraciones
COPY prisma ./prisma
COPY package*.json ./

# Copia prisma.config.ts + ts-node desde el builder para que migrate deploy pueda leerlo
COPY prisma.config.ts ./prisma.config.ts
COPY --from=builder /app/node_modules/ts-node ./node_modules/ts-node
COPY --from=builder /app/node_modules/typescript ./node_modules/typescript
COPY --from=builder /app/node_modules/tsconfig-paths ./node_modules/tsconfig-paths
COPY tsconfig.json ./tsconfig.json

EXPOSE 3000

# prisma migrate deploy usa ts-node para leer prisma.config.ts con DATABASE_URL
CMD ["sh", "-c", "npx prisma migrate deploy && node dist/src/main"]